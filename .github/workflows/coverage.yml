name: Coverage Report

on:
  pull_request:
    branches: [ main ]

jobs:
  coverage:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e ".[dev]"
    
    - name: Run tests with coverage
      run: |
        pytest tests/ --cov=merlin --cov-report=xml --cov-report=json --cov-report=term-missing
    
    - name: Parse coverage report
      run: |
        # Extract coverage percentage from pytest-cov output
        pytest tests/ --cov=merlin --cov-report=term-missing --cov-report=xml | tee coverage_output.txt
        
        # Extract coverage percentage from output
        COVERAGE=$(grep "TOTAL" coverage_output.txt | awk '{print $4}' | sed 's/%//')
        echo "COVERAGE_PERCENT=$COVERAGE" >> $GITHUB_ENV
        
        # Save coverage for comment
        echo "Overall coverage: $COVERAGE%" > coverage_summary.txt
        
        # Check if coverage meets 80% threshold
        if (( $(echo "$COVERAGE >= 80" | bc -l) )); then
          echo "STATUS=✅ Meeting target" >> $GITHUB_ENV
          echo "EMOJI=✅" >> $GITHUB_ENV
        elif (( $(echo "$COVERAGE >= 60" | bc -l) )); then
          echo "STATUS=⚠️ Below target" >> $GITHUB_ENV
          echo "EMOJI=⚠️" >> $GITHUB_ENV
        else
          echo "STATUS=❌ Well below target" >> $GITHUB_ENV
          echo "EMOJI=❌" >> $GITHUB_ENV
        fi
    
    - name: Comment PR with coverage
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          
          const coverage = process.env.COVERAGE_PERCENT || '0';
          const status = process.env.STATUS || '❌ Unknown';
          const emoji = process.env.EMOJI || '❌';
          
          const comment = `## ${emoji} Coverage Report
          
          **Overall Coverage:** ${coverage}%
          
          ### Coverage Status
          - **Target:** 80% (warning threshold)
          - **Current:** ${coverage}%
          - **Status:** ${status}
          
          ---
          *Coverage reports are informational and do not block PRs.*
          *Generated using pytest-cov*`;
          
          // Find existing coverage comment
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const existingComment = comments.find(comment => 
            comment.body.includes('Coverage Report') && comment.user.login === 'github-actions[bot]'
          );
          
          if (existingComment) {
            // Update existing comment
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: existingComment.id,
              body: comment
            });
          } else {
            // Create new comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
          }